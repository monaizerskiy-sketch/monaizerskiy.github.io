<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ascent: From Zero to Mogul</title>
    <!-- PWA Metadata -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" id="manifest-link" href="#">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the mobile-friendly game interface */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --secondary: #1f2937; /* Gray 800 */
            --background: #0f172a; /* Slate 900 */
            --text-light: #f3f4f6; /* Gray 100 */
            --accent-green: #10b981; /* Emerald 500 */
            --accent-red: #ef4444; /* Red 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 480px; /* Mobile width */
            padding: 0;
            margin: 0;
        }
        .stat-card {
            background-color: var(--secondary);
            border: 1px solid #374151;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }
        .stat-card:active {
            transform: scale(0.98);
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #374151;
            color: var(--text-light);
            transition: background-color 0.2s;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #4b5563;
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .tab-button {
            transition: color 0.2s, border-bottom 0.2s;
        }
        .tab-active {
            border-bottom: 3px solid var(--primary);
            color: var(--text-light);
            font-weight: 600;
        }
        /* Toast Animations */
        @keyframes slide-in-up {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slide-out-down {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, 100px); opacity: 0; }
        }
        .animate-slide-in-up {
            animation: slide-in-up 0.3s ease-out forwards;
        }
        .animate-slide-out-down {
            animation: slide-out-down 0.5s ease-in forwards;
        }
    </style>
    <!-- Configuration for Tailwind to use custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#1f2937',
                        'background': '#0f172a',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <!-- Firebase SDK Imports for single-file HTML -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL ENVIRONMENT SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        setLogLevel('debug'); // Enable Firestore logging

        let app, db, auth;
        let userId = null;
        let isGameReady = false; // Controls if game loop is running
        let isCloudLoaded = false; // Controls if initial cloud data has been merged
        let gameLoopInterval = null;

        // --- PWA Setup Logic ---
        const setupPWA = () => {
            const manifestData = {
                name: "The Ascent: Mogul",
                short_name: "The Ascent",
                description: "A Life and Career Simulator with cloud saves.",
                start_url: "./",
                display: "standalone",
                background_color: "#0f172a",
                theme_color: "#4f46e5",
                icons: [
                    { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
                    { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-link').href = manifestUrl;

            const swCode = `
                self.addEventListener('install', (event) => { self.skipWaiting(); });
                self.addEventListener('activate', (event) => { event.waitUntil(clients.claim()); });
                self.addEventListener('fetch', (event) => { event.respondWith(fetch(event.request)); });
            `;
            
            if ('serviceWorker' in navigator) {
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swUrl, { scope: './' })
                    .catch(err => console.error('Service Worker registration failed:', err));
            }
        };

        // --- Game Data Definitions (UNCHANGED) ---
        const EDUCATION_TIERS = [
            { id: 'None', name: 'None', cost: 0, studyTimeSec: 0 },
            { id: 'Diploma', name: 'High School Diploma', cost: 100, studyTimeSec: 10 },
            { id: 'Associate', name: 'Associate\'s Degree', cost: 5000, studyTimeSec: 60 },
            { id: 'Bachelor', name: 'Bachelor\'s Degree', cost: 50000, studyTimeSec: 180 },
            { id: 'Master', name: 'Master\'s Degree (MBA)', cost: 250000, studyTimeSec: 300 },
        ];
        const JOB_TIERS = [
            { id: 'Unemployed', name: 'Unemployed', requiredEducation: 'None', salary: 0, icon: 'ðŸ›‘' },
            { id: 'Janitor', name: 'Janitor', requiredEducation: 'None', salary: 1, icon: 'ðŸ§¹' },
            { id: 'OfficeAssistant', name: 'Office Assistant', requiredEducation: 'Diploma', salary: 5, icon: 'ðŸ—‚ï¸' },
            { id: 'TeamLead', name: 'Team Lead', requiredEducation: 'Associate', salary: 20, icon: 'ðŸ‘¨â€ðŸ’¼' },
            { id: 'CFO', name: 'CFO (Chief Financial Officer)', requiredEducation: 'Bachelor', salary: 100, icon: 'ðŸ“ˆ' },
            { id: 'Director', name: 'Company Director', requiredEducation: 'Master', salary: 500, icon: 'ðŸ‘‘' },
        ];
        const HUSTLE_UPGRADES = [
            { id: 'mouse', name: 'Ergonomic Mouse', cost: 50, clickBoost: 2, autoBoost: 0 },
            { id: 'chair', name: 'Better Office Chair', cost: 250, clickBoost: 5, autoBoost: 0 },
            { id: 'autov1', name: 'Auto-Clicker V1 (Bot)', cost: 1000, clickBoost: 0, autoBoost: 1 },
            { id: 'pc', name: 'Gaming PC Setup', cost: 5000, clickBoost: 15, autoBoost: 0 },
            { id: 'autov2', name: 'Auto-Clicker V2 (Advanced Bot)', cost: 50000, clickBoost: 0, autoBoost: 5 },
        ];
        const REAL_ESTATE_ASSETS = [
            { id: 'box', name: 'Cardboard Box', cost: 10, income: 0, icon: 'ðŸ“¦' },
            { id: 'studio', name: 'Studio Apartment', cost: 2000, income: 5, icon: 'ðŸ ' },
            { id: 'house', name: 'Suburban House', cost: 50000, income: 50, icon: 'ðŸ¡' },
            { id: 'penthouse', name: 'Luxury Penthouse', cost: 500000, income: 300, icon: 'ðŸ™ï¸' },
            { id: 'island', name: 'Private Island', cost: 10000000, income: 5000, icon: 'ðŸï¸' },
        ];
        const GAME_TICK_SECONDS = 5;
        const ONE_SECOND_MS = 1000;

        const defaultState = {
            cash: 10,
            netWorth: 10,
            educationLevel: 'None',
            jobId: 'Unemployed',
            clickValue: 1,
            autoClickRate: 0,
            assets: [],
            upgrades: [],
            studyEndTime: 0,
            lastSaveTime: Date.now(),
        };

        let gameState = { ...defaultState };

        // --- Utility Functions (UNCHANGED) ---
        const formatMoney = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0
            }).format(amount);
        };
        const getCurrentJob = () => JOB_TIERS.find(job => job.id === gameState.jobId) || JOB_TIERS[0];
        const getCurrentEducation = () => EDUCATION_TIERS.find(edu => edu.id === gameState.educationLevel) || EDUCATION_TIERS[0];
        const getEducationById = (id) => EDUCATION_TIERS.find(edu => edu.id === id);
        const getEducationIndex = (id) => EDUCATION_TIERS.findIndex(edu => edu.id === id);
        const getNextEducationTier = () => {
            const currentIdx = getEducationIndex(gameState.educationLevel);
            return EDUCATION_TIERS[currentIdx + 1] || null;
        };
        const calculateNetWorth = () => {
            const assetValue = gameState.assets.reduce((sum, asset) => {
                const item = REAL_ESTATE_ASSETS.find(a => a.id === asset.id);
                return sum + (item ? item.cost * asset.count : 0);
            }, 0);
            return gameState.cash + assetValue;
        };

        /** Updates the calculated state values and ensures persistence. */
        const updateGameCalculations = () => {
            gameState.netWorth = calculateNetWorth();

            // Recalculate total click value and auto-rate from upgrades
            gameState.clickValue = 1;
            gameState.autoClickRate = 0;

            gameState.upgrades.forEach(upgradeId => {
                const upgrade = HUSTLE_UPGRADES.find(u => u.id === upgradeId);
                if (upgrade) {
                    gameState.clickValue += upgrade.clickBoost;
                    gameState.autoClickRate += upgrade.autoBoost;
                }
            });

            // Update UI
            renderUI();
        };

        /** Gets the total money earned per tick from passive sources (Salary + Assets). */
        const getPassiveIncomePerTick = () => {
            const currentJob = getCurrentJob();
            let totalIncome = currentJob.salary;
            
            totalIncome += gameState.assets.reduce((sum, asset) => {
                const item = REAL_ESTATE_ASSETS.find(a => a.id === asset.id);
                return sum + (item ? item.income * asset.count : 0);
            }, 0);

            totalIncome += gameState.autoClickRate * GAME_TICK_SECONDS;
            return totalIncome;
        }

        /** Processes income that was missed while the app was closed. */
        const processOfflineIncome = (ticksMissed) => {
            if (ticksMissed > 0) {
                const passiveIncomePerTick = getPassiveIncomePerTick();
                const totalOfflineIncome = passiveIncomePerTick * ticksMissed;
                gameState.cash += totalOfflineIncome;

                showToast(`ðŸ’° Welcome back! Earned ${formatMoney(totalOfflineIncome)} offline over ${ticksMissed} intervals.`);
            }
        };
        
        // --- Firebase Persistence ---
        const getSaveRef = () => {
            if (!userId || !db) return null;
            // Private data path: /artifacts/{appId}/users/{userId}/game_data/main_save
            const docPath = `/artifacts/${appId}/users/${userId}/game_data/main_save`;
            return doc(db, docPath);
        };

        const saveGame = async () => {
            if (!isGameReady || !userId || !db) return;
            const saveRef = getSaveRef();
            if (saveRef) {
                try {
                    gameState.lastSaveTime = Date.now();
                    await setDoc(saveRef, gameState);
                } catch (error) {
                    console.error("Error saving game:", error);
                }
            }
        };

        /** Loads and syncs the game state from Firestore using a real-time listener. */
        const loadGame = () => {
            const saveRef = getSaveRef();
            if (saveRef) {
                onSnapshot(saveRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const loadedState = docSnap.data();
                        
                        // Merge loaded data with current running state
                        Object.assign(gameState, { ...defaultState, ...loadedState });
                        
                        // Only calculate offline income on the *first* load
                        if (!isCloudLoaded) {
                            const timeElapsed = Date.now() - gameState.lastSaveTime;
                            const ticksMissed = Math.floor(timeElapsed / (GAME_TICK_SECONDS * ONE_SECOND_MS));
                            processOfflineIncome(ticksMissed);
                            isCloudLoaded = true;
                            showToast('Cloud save loaded successfully.');
                        } else {
                             // Subsequent updates are just syncing (no offline earnings calc needed)
                            showToast('Game state synced from cloud.');
                        }
                    } else {
                        // If no save data exists, we save the current default/local state
                        if (!isCloudLoaded) {
                            showToast('No cloud save found. Starting a new game.');
                            saveGame();
                            isCloudLoaded = true;
                        }
                    }
                    
                    updateGameCalculations();
                }, (error) => {
                    console.error("Error listening to game state:", error);
                    // Inform the user that cloud sync failed
                    showToast('Error syncing cloud data. Playing locally.');
                });
            }
        };
        
        // --- Core Game Logic ---
        const gameLoop = () => {
            // 1. Check if studying is complete
            if (gameState.studyEndTime > 0 && Date.now() >= gameState.studyEndTime) {
                const nextEdu = getNextEducationTier();
                gameState.educationLevel = nextEdu.id;
                gameState.studyEndTime = 0;
                showToast(`ðŸŽ“ Study complete! You now have a ${nextEdu.name}.`);
            }
            
            // 2. Process Passive Income (Salary + Assets + Auto-Clicker)
            const passiveIncome = getPassiveIncomePerTick();
            gameState.cash += passiveIncome;
            
            // 3. Update calculations and UI
            updateGameCalculations();
            
            // 4. Auto-save
            saveGame();
        };

        /** Starts the main game loop and shows the UI immediately. */
        const startGameLoop = () => {
            if (isGameReady) return;
            
            // Set the interval and flag
            gameLoopInterval = setInterval(gameLoop, GAME_TICK_SECONDS * ONE_SECOND_MS);
            isGameReady = true;

            // Remove the loading state IMMEDIATELY (addresses user's primary concern)
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            // Initial render using default state
            updateGameCalculations();
            
            // Set up initial tab view
            changeTab(currentTab);

            console.log("Game loop started immediately with default state.");
        };

        const handleTap = () => {
            if (gameState.studyEndTime > 0) {
                showToast('You must finish studying before you can hustle!');
                return;
            }
            gameState.cash += gameState.clickValue;
            updateGameCalculations();
            saveGame();
        };
        
        const purchaseItem = (type, itemId, cost) => {
            if (gameState.cash < cost) {
                showToast("Not enough cash!");
                return;
            }
            
            gameState.cash -= cost;
            
            switch(type) {
                case 'upgrade':
                    gameState.upgrades.push(itemId);
                    showToast(`ðŸ›’ Purchased: ${HUSTLE_UPGRADES.find(u => u.id === itemId).name}!`);
                    break;
                case 'education':
                    const edu = getEducationById(itemId);
                    gameState.studyEndTime = Date.now() + edu.studyTimeSec * ONE_SECOND_MS;
                    showToast(`ðŸ“š Enrolled in ${edu.name}! Studying will take ${edu.studyTimeSec} seconds...`);
                    gameState.jobId = 'Unemployed'; // Resets job when studying
                    break;
                case 'job':
                    gameState.jobId = itemId;
                    showToast(`ðŸ‘” New Job! Now working as a ${JOB_TIERS.find(j => j.id === itemId).name}.`);
                    break;
                case 'asset':
                    const assetItem = REAL_ESTATE_ASSETS.find(a => a.id === itemId);
                    const existingAsset = gameState.assets.find(a => a.id === itemId);
                    if (existingAsset) {
                        existingAsset.count += 1;
                    } else {
                        gameState.assets.push({ id: itemId, count: 1 });
                    }
                    showToast(`ðŸ¡ Purchased: ${assetItem.name}! Passive income increased.`);
                    break;
            }
            updateGameCalculations();
            saveGame();
        };

        // --- UI Rendering (UNCHANGED) ---
        let currentTab = 'Dashboard';
        const changeTab = (tab) => {
            currentTab = tab;
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('tab-active', btn.dataset.tab === tab);
            });
            renderContent();
            document.getElementById('content-area').scrollTop = 0;
        };
        
        const renderUI = () => {
            // Update Stats Display
            document.getElementById('cash-value').textContent = formatMoney(gameState.cash);
            document.getElementById('networth-value').textContent = formatMoney(gameState.netWorth);
            document.getElementById('passive-value').textContent = formatMoney(getPassiveIncomePerTick()) + ` / ${GAME_TICK_SECONDS}s`;
            document.getElementById('click-value').textContent = formatMoney(gameState.clickValue) + ' per Tap';
            document.getElementById('user-id').textContent = userId || (auth ? 'Connecting...' : 'Initializing...');

            renderContent();
        };

        const renderContent = () => {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';

            switch (currentTab) {
                case 'Dashboard': renderDashboard(contentArea); break;
                case 'Career': renderCareer(contentArea); break;
                case 'Assets': renderAssets(contentArea); break;
                case 'Hustle': renderHustle(contentArea); break;
            }
        };

        // Note: renderDashboard, renderCareer, renderAssets, renderHustle functions are kept exactly the same for brevity, 
        // as they handle the dynamic HTML generation based on the current 'gameState'.
        const renderDashboard = (container) => {
            const currentJob = getCurrentJob();
            let studyStatus = '';
            let isStudying = gameState.studyEndTime > 0;
            if (isStudying) {
                const remainingSec = Math.max(0, Math.floor((gameState.studyEndTime - Date.now()) / ONE_SECOND_MS));
                const nextEdu = getNextEducationTier();
                const minutes = Math.floor(remainingSec / 60);
                const seconds = remainingSec % 60;
                studyStatus = `
                    <div class="p-4 bg-yellow-900/30 rounded-lg text-yellow-300 mb-4 animate-pulse">
                        <p class="font-bold">ðŸ“š Currently Studying: ${nextEdu.name}</p>
                        <p class="text-sm">Time Remaining: ${minutes}m ${seconds}s</p>
                    </div>
                `;
                if (isStudying) { setTimeout(() => renderContent(), ONE_SECOND_MS); }
            }
            container.innerHTML = `
                <div class="p-4">
                    <h2 class="text-2xl font-bold mb-4 text-primary">Status Overview</h2>
                    ${studyStatus}
                    <div class="stat-card p-4 rounded-xl mb-4">
                        <p class="text-sm text-gray-400">Current Position</p>
                        <p class="text-3xl font-extrabold flex items-center">${currentJob.icon} ${currentJob.name}</p>
                        <p class="text-lg text-accent-green mt-1">Salary: ${formatMoney(currentJob.salary)} / ${GAME_TICK_SECONDS}s</p>
                    </div>
                    <div class="stat-card p-4 rounded-xl mb-4">
                        <p class="text-sm text-gray-400">Highest Education</p>
                        <p class="text-3xl font-extrabold flex items-center">ðŸŽ“ ${getCurrentEducation().name}</p>
                    </div>
                    <div class="stat-card p-4 rounded-xl mb-4">
                        <p class="text-sm text-gray-400">Real Estate Owned</p>
                        ${gameState.assets.length === 0 
                            ? '<p class="text-xl text-gray-500 mt-2">None yet. Start investing!</p>' 
                            : gameState.assets.map(asset => {
                                const item = REAL_ESTATE_ASSETS.find(a => a.id === asset.id);
                                return `<p class="text-xl mt-1">${item.icon} ${item.name} x${asset.count} <span class="text-accent-green text-sm float-right">+${formatMoney(item.income * asset.count)} / ${GAME_TICK_SECONDS}s</span></p>`;
                            }).join('')
                        }
                    </div>
                    <p class="text-sm text-gray-500 pt-2 text-center">Game saves automatically every ${GAME_TICK_SECONDS} seconds.</p>
                </div>
            `;
        };

        const renderCareer = (container) => {
            const currentEduIdx = getEducationIndex(gameState.educationLevel);
            const isStudying = gameState.studyEndTime > 0;
            let html = '<div class="p-4">';
            html += `<h2 class="text-2xl font-bold mb-4 text-primary">Career Advancement</h2>`;
            html += `<h3 class="text-xl font-semibold mb-3 text-gray-200 border-b border-gray-700 pb-2">1. Education Track</h3>`;
            const nextEdu = getNextEducationTier();
            if (nextEdu) {
                const isAffordable = gameState.cash >= nextEdu.cost;
                const buttonClass = isAffordable && !isStudying ? 'btn-primary' : 'btn-secondary btn-disabled';
                const buttonText = isStudying ? 'STUDY IN PROGRESS' : isAffordable ? `Enroll Now (${formatMoney(nextEdu.cost)})` : 'Too Expensive';
                html += `
                    <div class="stat-card p-4 rounded-xl mb-4">
                        <p class="text-xl font-bold">Next Goal: ${nextEdu.name}</p>
                        <p class="text-sm text-gray-400">Cost: ${formatMoney(nextEdu.cost)} | Time: ${nextEdu.studyTimeSec} seconds</p>
                        <button class="w-full mt-3 p-3 rounded-lg ${buttonClass}" 
                                onclick="if(!this.disabled) purchaseItem('education', '${nextEdu.id}', ${nextEdu.cost})"
                                ${!isAffordable || isStudying ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            } else { html += `<p class="p-4 bg-green-900/30 rounded-lg">ðŸŽ“ Maximum Education Achieved!</p>`; }
            html += `<h3 class="text-xl font-semibold mt-6 mb-3 text-gray-200 border-b border-gray-700 pb-2">2. Corporate Ladder</h3>`;
            JOB_TIERS.forEach(job => {
                if (job.id === gameState.jobId) return;
                const requiredEduIdx = getEducationIndex(job.requiredEducation);
                const canApply = currentEduIdx >= requiredEduIdx;
                const buttonClass = canApply ? 'btn-primary' : 'btn-secondary btn-disabled';
                const requiredEduName = getEducationById(job.requiredEducation).name;
                const buttonText = canApply ? `APPLY (${formatMoney(job.salary)}/tick)` : `Requires: ${requiredEduName}`;
                html += `
                    <div class="stat-card p-4 rounded-xl mb-3 flex justify-between items-center">
                        <div>
                            <p class="text-xl font-bold flex items-center">${job.icon} ${job.name}</p>
                            <p class="text-sm text-gray-400">Salary: ${formatMoney(job.salary)} / ${GAME_TICK_SECONDS}s</p>
                        </div>
                        <button class="p-2 px-4 rounded-lg text-sm ${buttonClass}" 
                                onclick="if(!this.disabled) purchaseItem('job', '${job.id}', 0)"
                                ${!canApply ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        };

        const renderAssets = (container) => {
            let html = '<div class="p-4">';
            html += `<h2 class="text-2xl font-bold mb-4 text-primary">Assets & Investments</h2>`;
            html += `<p class="text-sm text-gray-400 mb-4">Buy Real Estate for long-term passive income and increased Net Worth.</p>`;
            REAL_ESTATE_ASSETS.forEach(asset => {
                const isAffordable = gameState.cash >= asset.cost;
                const buttonClass = isAffordable ? 'btn-primary' : 'btn-secondary btn-disabled';
                const buttonText = isAffordable ? `BUY (${formatMoney(asset.cost)})` : 'Too Expensive';
                const ownedCount = (gameState.assets.find(a => a.id === asset.id) || { count: 0 }).count;
                html += `
                    <div class="stat-card p-4 rounded-xl mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xl font-bold flex items-center">${asset.icon} ${asset.name}</p>
                                <p class="text-sm text-gray-400">Income: <span class="text-accent-green">+${formatMoney(asset.income)} / ${GAME_TICK_SECONDS}s</span></p>
                                <p class="text-sm text-gray-500">Owned: ${ownedCount}</p>
                            </div>
                            <button class="p-2 px-4 rounded-lg text-sm ${buttonClass}" 
                                    onclick="if(!this.disabled) purchaseItem('asset', '${asset.id}', ${asset.cost})"
                                    ${!isAffordable ? 'disabled' : ''}>
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        };

        const renderHustle = (container) => {
            let html = '<div class="p-4">';
            html += `<h2 class="text-2xl font-bold mb-4 text-primary">The Hustle (Equipment)</h2>`;
            html += `<p class="text-sm text-gray-400 mb-4">Upgrade your equipment to increase your Click Value and your passive Auto-Clicker rate.</p>`;
            HUSTLE_UPGRADES.forEach(upgrade => {
                const isPurchased = gameState.upgrades.includes(upgrade.id);
                const isAffordable = gameState.cash >= upgrade.cost;
                const buttonClass = isPurchased ? 'btn-secondary btn-disabled' : isAffordable ? 'btn-primary' : 'btn-secondary btn-disabled';
                const buttonText = isPurchased ? 'OWNED' : isAffordable ? `BUY (${formatMoney(upgrade.cost)})` : 'Too Expensive';
                
                let stats = [];
                if (upgrade.clickBoost > 0) stats.push(`+${formatMoney(upgrade.clickBoost)} Click Value`);
                if (upgrade.autoBoost > 0) stats.push(`+${formatMoney(upgrade.autoBoost)} Auto/sec`);
                html += `
                    <div class="stat-card p-4 rounded-xl mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xl font-bold">${upgrade.name}</p>
                                <p class="text-sm text-accent-green">${stats.join(' | ')}</p>
                            </div>
                            <button class="p-2 px-4 rounded-lg text-sm ${buttonClass}" 
                                    onclick="if(!this.disabled) purchaseItem('upgrade', '${upgrade.id}', ${upgrade.cost})"
                                    ${isPurchased || !isAffordable ? 'disabled' : ''}>
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        };

        const showToast = (message) => {
            const toast = document.getElementById('toast');
            // Ensure any previous slide-out animation is cleared before showing new toast
            toast.classList.remove('hidden', 'animate-slide-out-down');
            toast.textContent = message;
            toast.classList.add('animate-slide-in-up');
            
            setTimeout(() => {
                toast.classList.remove('animate-slide-in-up');
                toast.classList.add('animate-slide-out-down');
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('animate-slide-out-down');
                }, 500);
            }, 3000);
        };

        // --- Initialization and Authentication (Optimized) ---

        /** Initializes Firebase and handles authentication. This runs asynchronously after the game loop starts. */
        const initAuthAndCloud = () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch(e) {
                console.error("Firebase Initialization Error:", e);
                document.getElementById('loading-message').textContent = "Initialization Failed. Playing in Offline Mode.";
                return;
            }

            // Authentication listener: This sets the userId and triggers the cloud load process.
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').textContent = userId;
                    document.getElementById('loading-message').textContent = "Connected. Syncing cloud data...";
                    // Start cloud data sync once authenticated
                    loadGame(); 
                } else {
                    // This handles initial sign-in attempt failures or sign-out
                    console.log("User not authenticated. Falling back to Anonymous Sign-In.");
                    signInAnonymously(auth).catch(e => {
                        console.error("Anonymous Sign-in failed:", e);
                        document.getElementById('loading-message').textContent = "Cloud connection unavailable.";
                    });
                }
            });

            // Attempt initial sign-in using the provided custom token or fall back to anonymous
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.error("Custom Token Sign-in failed. Retrying anonymously.", e);
                    // The onAuthStateChanged listener will handle the anonymous fallback
                });
            } else {
                signInAnonymously(auth).catch(e => {
                    console.error("Anonymous Sign-in failed:", e);
                });
            }
        };
        
        // --- Main Entry Point ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. PWA Setup
            setupPWA();
            
            // 2. Start the game loop IMMEDIATELY with default data (eliminates perceived delay)
            startGameLoop(); 

            // 3. Start the long-running async authentication and cloud data process
            initAuthAndCloud();
        });
        
        // Expose functions globally for HTML event handlers
        window.handleTap = handleTap;
        window.purchaseItem = purchaseItem;
        window.changeTab = changeTab;
    </script>

    <!-- Main Application UI -->
    <div class="container flex flex-col items-center">
        
        <!-- Header & Stats Panel -->
        <header class="w-full bg-secondary p-4 rounded-b-xl shadow-lg z-10">
            <h1 class="text-2xl font-extrabold text-center text-primary mb-2">The Ascent</h1>
            <div class="grid grid-cols-2 gap-3">
                
                <!-- Cash Stat (Tap Target) -->
                <div class="stat-card p-3 rounded-xl text-center" ontouchstart="handleTap()" onclick="handleTap()">
                    <p class="text-xs text-gray-400">Cash (Tap Me!)</p>
                    <p id="cash-value" class="text-xl font-bold text-accent-green">$10</p>
                </div>

                <!-- Net Worth Stat -->
                <div class="stat-card p-3 rounded-xl text-center">
                    <p class="text-xs text-gray-400">Net Worth</p>
                    <p id="networth-value" class="text-xl font-bold">$10</p>
                </div>

                <!-- Passive Income Stat -->
                <div class="stat-card p-3 rounded-xl text-center">
                    <p class="text-xs text-gray-400">Passive Income</p>
                    <p id="passive-value" class="text-lg font-semibold text-accent-green">$$0 / 5s</p>
                </div>

                <!-- Click Value Stat -->
                <div class="stat-card p-3 rounded-xl text-center">
                    <p class="text-xs text-gray-400">Click Value</p>
                    <p id="click-value" class="text-lg font-semibold text-primary">$1 per Tap</p>
                </div>
            </div>
            <p class="text-xs text-center text-gray-500 mt-2">User ID: <span id="user-id">Initializing...</span></p>
        </header>

        <!-- Tab Navigation -->
        <nav class="w-full sticky top-0 bg-background/95 backdrop-blur-sm shadow-xl z-10 border-b border-gray-700">
            <div class="flex justify-around text-gray-400 font-medium">
                <button class="tab-button w-full p-3 tab-active" data-tab="Dashboard" onclick="changeTab('Dashboard')">Dashboard</button>
                <button class="tab-button w-full p-3" data-tab="Hustle" onclick="changeTab('Hustle')">Hustle</button>
                <button class="tab-button w-full p-3" data-tab="Career" onclick="changeTab('Career')">Career</button>
                <button class="tab-button w-full p-3" data-tab="Assets" onclick="changeTab('Assets')">Assets</button>
            </div>
        </nav>

        <!-- Loading State (Temporary, quickly hidden) -->
        <div id="loading-state" class="flex flex-col items-center justify-center p-8 mt-12">
            <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-message" class="mt-4 text-gray-400">Starting game instantly...</p>
        </div>

        <!-- Main Content Area (Hidden until game loop starts) -->
        <main id="app-content" class="w-full flex-grow overflow-y-auto hidden">
            <div id="content-area" class="pb-20">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </main>
        
        <!-- Toast Notification (for user feedback) -->
        <div id="toast" class="hidden fixed bottom-0 left-1/2 transform -translate-x-1/2 mb-4 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-2xl z-50 transition-all duration-300" style="min-width: 80%;">
            Notification Message
        </div>
    </div>
</body>
</html>

